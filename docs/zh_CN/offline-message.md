[English](../en_US/offline-message.md)  | 简体中文


## 离线消息支持

离线消息是指当客户端与服务端断开连接期间，服务端保存的消息，在客户端重新连接并恢复会话时再投递（deliver）给客户端。

---

### 功能描述

* 当客户端使用 **Clean Session=false / Clean Start=false** 建立会话时，如果客户端断开连接，服务端会保存发往该客户端的 **QoS ≥ 1** 的消息作为离线消息。
* 当客户端重新连接并选择恢复会话时，服务端会将这些离线消息统一下发。
* 如果客户端使用 **Clean Session=true / Clean Start=true** 建立新会话，或者原有会话已经过期，则之前存储的离线消息会被清除。

---

### 存储方式

#### 1. 内存存储（默认）

即使 **未启用 `store-session` 插件**，rmqtt 仍然支持离线消息存储。

* 消息存储在内存中。
* 适用于短时断开和快速重连场景。
* 服务器进程重启后，内存中的离线消息会丢失。

#### 2. 持久化存储（通过 `store-session` 插件）

若启用 **`rmqtt-session-storage` 插件**，离线消息会随会话一起被持久化。

* 支持存储在本地（sled）、Redis 或 Redis-Cluster。
* 服务器重启后仍可恢复会话和离线消息。
* 适用于对可靠性要求较高的生产环境。

> 参考：[会话存储文档](../zh_CN/store-session.md)

---

### 生命周期与行为

| 阶段                                           | 离线消息处理                                                     |
| -------------------------------------------- | ---------------------------------------------------------- |
| 客户端断开连接                                      | 若会话未过期，服务端保留 QoS ≥ 1 的离线消息（内存或持久化）。                        |
| 消息超过过期时间                                     | 若配置了 `message_expiry_interval`，超过该时长未投递的离线消息会被丢弃（0 表示不过期）。 |
| 客户端重连并恢复会话                                   | 下发所有未过期的离线消息。                                              |
| 客户端重连但 Clean Session=true / Clean Start=true | 新建会话，之前的离线消息被清除。                                           |
| 会话过期                                         | 所有关联的离线消息被清除。                                              |
| 服务重启                                         | - 若仅内存存储 → 离线消息丢失。<br> - 若启用持久化 → 离线消息可恢复并继续投递。            |

---

### 相关配置项（`rmqtt.toml`）

在主配置文件 **`rmqtt.toml`** 中，可通过以下参数控制离线消息相关行为：

```toml
# 消息队列的最大长度，超过该长度时，旧消息将被丢弃
listener.tcp.external.max_mqueue_len = 1000

# 消息过期时间，0 表示不过期，默认值 5 分钟
listener.tcp.external.message_expiry_interval = "5m"

# 非活跃会话过期时间，默认值 2 小时
listener.tcp.external.session_expiry_interval = "2h"
```

* **max\_mqueue\_len**
  控制每个会话的离线消息队列长度。队列满后，**最早的旧消息会被丢弃，以便接收新的消息**，避免无限制积压。

* **message\_expiry\_interval**
  指定单条消息的过期时间。如果超过该时间仍未投递给客户端，消息将被丢弃。

* **session\_expiry\_interval**
  控制会话在断开后的最长保留时长。会话到期后，其订阅关系与离线消息都会被清除。

---

### 注意事项

* **消息存储量**：消息过多可能导致内存或存储膨胀，建议合理配置 `max_mqueue_len` 与过期参数。
* **顺序与重复**：MQTT 协议允许消息重复投递，rmqtt 会尽量保持顺序，客户端需支持幂等处理。
* **存储引擎选择**：开发测试环境可以使用内存；生产环境推荐启用 `store-session` 插件并结合 Redis/Redis-Cluster。

